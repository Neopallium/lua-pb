// Copyright 2013 Google Inc. All Rights Reserved.

// This is the message that Google uses to request bids.  A single BidRequest
// includes all applicable ad slots from a single impression.
//
message BidRequest {
  // Unique request id generated by Google.  This is 16 bytes long.
  required bytes id = 2;

  // -----------------------------------------------------------
  // This section lists information that we know about the user.

  // The first 3 bytes of the IP address in network byte order for IPv4, or the
  // first 6 bytes for IPv6.  Note that the number and position of the bytes
  // included from IPv6 addresses may change later.
  optional bytes ip = 4;

  // The Google ID for the user as described in the documentation for the cookie
  // matching service.  This field is the unpadded web-safe base64 encoded
  // version of a binary cookie id. See the "Base 64 Encoding with URL and
  // Filename Safe Alphabet" section in RFC 3548 for encoding details.  This
  // field is the same as the Google ID returned by the cookie matching service.
  optional string google_user_id = 21;

  // The version number of the google_user_id.  We may sometimes change the
  // mapping from cookie to google_user_id.  In this case the version will be
  // incremented.
  optional uint32 cookie_version = 20;

  // The time in seconds since the google_user_id was created.
  optional int32 cookie_age_seconds = 31;

  // Match data stored for this google_user_id through the cookie matching
  // service.  If a match exists, then this field holds the decoded data that
  // was passed in the google_hm parameter.
  optional bytes hosted_match_data = 37;

  // A string that identifies the browser and type of device that sent the
  // request.
  optional string user_agent = 6;

  // Geo information.  These use a subset of the codes used in the AdWords API.
  // See the geo-tables.csv table in the technical documentation for a list of
  // ids.  The geo_criteria_id field replaces the deprecated country, region,
  // city, and metro fields.
  optional int32 geo_criteria_id = 39;

  // Detected postal code of the appropriate type for the country (e.g. zip code
  // if the country is "US").  The postal_code_prefix field is set when accuracy
  // is too low to imply a full code, otherwise the postal_code field is set.
  optional string postal_code = 33;
  optional string postal_code_prefix = 34;

  // The offset of the user's time from GMT in minutes.  For example, GMT+10 is
  // timezone_offset = 600.
  optional int32 timezone_offset = 25;

  // List of detected user verticals.  Currently unused.
  repeated int32 user_vertical = 30 [packed=true];

  // Audience-targeting list to which the user has been added. See the Buyer UI
  // Help topics on remarketing, where it is called a remarketing list.
  message UserList {
    // The user list id.
    optional int64 id = 1;

    // The time in seconds since the user was added to the list.
    optional int32 age_seconds = 2;
  }
  repeated UserList user_list = 32;

  // -----------------------------------------------------------
  // This section lists information that we know about the web page or mobile
  // application where the impression originates.

  // The seller network id.  See seller-network-ids.txt file in the technical
  // documentation for a list of ids.  This is only set if the site is not
  // anonymous and the publisher allows site targeting.
  optional int32 seller_network_id = 41;

  // The URL of the page with parameters removed.  This is only set if the site
  // is not anonymous and the publisher allows site targeting.  You can use
  // anonymous_id for targeting if the inventory is anonymous.  Otherwise, use
  // detected_vertical's.
  optional string url = 11;

  // An id for the domain of the page.  This is set when the inventory is
  // anonymous.
  optional string anonymous_id = 19;

  // The two or 5 letter code for the languages of the page or the user.  The
  // documentation for the codes is at
  // https://developers.google.com/adwords/api/docs/appendix/languagecodes
  repeated string detected_language = 12;

  // One or more detected verticals for the page as determined by Google.
  //
  message Vertical {
    // The vertical id.  See the publisher-verticals.txt file in the technical
    // documentation for a list of ids.
    required int32 id = 1;

    // Weight for this vertical, in the (0.0, 1.0] range.  More relevant
    // verticals have higher weights.
    required float weight = 2;
  }

  // Unordered list of detected content verticals.  See the
  // publisher-verticals.txt file in the technical documentation for a list of
  // ids.
  repeated Vertical detected_vertical = 13;

  // The dictionary version used in the detected_vertical field.  This is
  // currently always "2".
  optional int32 vertical_dictionary_version = 24;

  // List of detected content labels.  See content-labels.txt file in the
  // technical documentation for a list of ids.
  repeated int32 detected_content_label = 26 [packed=true];

  // Site lists that apply to this publisher.  See site-lists.txt in the
  // technical documentation for a list of ids.
  repeated int32 site_list_id = 36;

  // Additional key-value attributes.  Currently unused.
  message KeyValue {
    optional string key = 1;
    optional string value = 2;
  }
  repeated KeyValue key_value = 38;

  // Information for ad queries coming from mobile devices.  A mobile device is
  // either a smartphone or a tablet.  This is present for ad queries both from
  // mobile devices browsing the web and from mobile apps.
  message Mobile {
    // The platform of the mobile device.  Examples: android, iphone, palm
    optional string platform = 3;

    // The brand of the mobile device, e.g. Nokia, Samsung.
    optional string brand = 12;

    // The model of the mobile device, e.g. N70, Galaxy.
    optional string model = 13;

    // This message contains the OS version of the platform.  For instance, for
    // Android 2.1, os_version_major=2, os_version_minor=1, and os_version_micro
    // will remain unpopulated.  For iPhone 3.3.1, os_version_major=3,
    // os_version_minor=3, and os_version_micro=1.
    message DeviceOsVersion {
      optional int32 os_version_major = 1;
      optional int32 os_version_minor = 2;
      optional int32 os_version_micro = 3;
    }

    // The OS version; e.g. 2.1 for Android 2.1, or 3.3.1 for iOS 3.3.1.
    optional DeviceOsVersion os_version = 14;

    // This is the identifier uniquely identifies the mobile carrier when the
    // mobile device is connected to the internet via the carrier (as opposed
    // to via WiFi).  To look up carrier name and country from carrier ID,
    // please refer to
    // https://developers.google.com/adwords/api/docs/appendix/mobilecarriers.
    optional int64 carrier_id = 18;

    // If true, then this request is from a mobile application. Will always be
    // true when app_id is set.  May also be true for anonymous inventory, in
    // which case anonymous_id will be set.
    optional bool is_app = 7 [default = false];

    // The identifier of the mobile app when this ad query comes from a mobile
    // app.  If the app was downloaded from the Apple iTunes app store, then
    // this is the app-store id.  For Android devices, this is the fully
    // qualified package name.  Examples: 343200656, com.rovio.angrybirds
    optional string app_id = 6;

    // The type of mobile device in which the ad will be shown.
    enum MobileDeviceType {
      UNKNOWN = 0;
      HIGHEND_PHONE = 1;
      TABLET = 2;
    }
    optional MobileDeviceType mobile_device_type = 8 [default = UNKNOWN];

    // The width of the mobile device screen in pixels.
    optional int32 screen_width = 15;

    // The height of the mobile device screen in pixels.
    optional int32 screen_height = 16;

    // The screen orientation of the device when the ad request is sent.
    enum ScreenOrientation {
      SCREEN_ORIENTATION_UNKNOWN = 0;
      SCREEN_ORIENTATION_PORTRAIT = 1;
      SCREEN_ORIENTATION_LANDSCAPE = 2;
    }
    optional int32 screen_orientation = 9 [default = 0];

    // If true, then this is a mobile full screen ad request.
    optional bool is_interstitial_request = 10 [default = false];

    // This field contains the IDs of categories to which the current mobile app
    // belongs.  This field will be empty if is_app is false.  The mapping
    // between mobile apps and categories is defined by the Google Play Store
    // for Android apps, or the Apple iTunes Store for iOS apps.  To look up
    // category name from category ID, please refer to
    // https://developers.google.com/adwords/api/docs/appendix/mobileappcategories
    repeated int32 app_category_ids = 11;

    // For a mobile web request, this field indicates whether the page is
    // optimized for mobile browsers on high-end mobile phones.
    optional bool is_mobile_web_optimized = 17 [default=false];

    // Used for high-density devices (e.g. iOS retina displays), where non-
    // default value indicates that the nominal screen size (with pixels as the
    // unit) does not describe the actual number of pixels in the screen. For
    // example, nominal width and height may be 320x640 for a screen that
    // actually has 640x1080 pixels, in which case screen_width=320,
    // screen_height=640, and device_pixel_ratio_millis=2000, since each axis
    // has twice as many pixels as its dimensions would indicate.
    optional int32 device_pixel_ratio_millis = 19 [default=1000];

    // Apple's identifier for advertising (IDFA) when available, encrypted as
    // described at
    // https://developers.google.com/ad-exchange/rtb/response-guide/decrypt-idfa
    // For encrypted_idfa the plaintext achieved after decrypting the ciphertext
    // is the IDFA returned by iOS's [ASIdentifierManager
    // advertisingIdentifier].  For encrypted_hashed_idfa the plaintext is the
    // MD5 hash of the IDFA.  Only one of the two fields will be available,
    // depending on the version of the SDK making the request.  Later SDKs will
    // provide the IDFA unhashed.
    optional bytes encrypted_idfa = 20;
    optional bytes encrypted_hashed_idfa = 21;

    // These are deprecated.  Please ignore.
    optional string DEPRECATED_app_name = 1;
    optional string DEPRECATED_company_name = 2;
    optional string DEPRECATED_carrier_name = 4;
    optional string DEPRECATED_carrier_country = 5;
  }
  optional Mobile mobile = 28;

  // Information about the video if this is an in-video ad request.
  //
  message Video {
    // The time in milliseconds from the start of the video when the ad will be
    // displayed.  0 means pre-roll and -1 means post-roll.  The value is valid
    // only if this param is set.  When not set, the display position is
    // unknown.
    optional int32 videoad_start_delay = 1;

    // The maximum duration in milliseconds of the ad that you should return.
    // If this is not set or has value <= 0, any duration is allowed.
    optional int32 max_ad_duration = 2;

    // The minimum duration in milliseconds of the ad that you should return.
    // If this is not set or has value <= 0, there is no minimum duration.
    optional int32 min_ad_duration = 8;

    // The type of inventory from which request is sent.
    enum InventoryType {
      WEB_VIDEO = 0;
      GAMES = 1;
      MOBILE_INTERSTITIAL = 2;
    }
    optional int32 inventory_type = 3 [default = 0];

    // Does the publisher allow/require/block skippable video ads?  If this
    // field is not set, skippable ads are allowed.
    enum SkippableBidRequestType {
      ALLOW_SKIPPABLE = 0;
      REQUIRE_SKIPPABLE = 1;
      BLOCK_SKIPPABLE = 2;
    }
    optional SkippableBidRequestType video_ad_skippable = 4 [default =
        ALLOW_SKIPPABLE];

    // The maximum duration in milliseconds for the ad you should return, if
    // this ad is skippable (this generally differs from the maximum duration
    // allowed for non-skippable ads).  If this is not set or has value <= 0,
    // any duration is allowed.
    optional int32 skippable_max_ad_duration = 5;

    // The video technologies that are allowed for this request. The response
    // should support at least one of them.
    enum VideoFormat {
      VIDEO_FLASH = 0;
      VIDEO_HTML5 = 1;  // Valid HTML5 VAST ads contain both mp4 and webm media
                        // files in the first Ad/Creative VAST node.
    };
    repeated VideoFormat allowed_video_formats = 6;

    // Information about the companion ad slots that can be shown with the
    // video.  While this is a repeated field there will only be one value in
    // most cases.  If there are no companion ads available this field will not
    // be set.
    //
    message CompanionSlot {
      // These fields represent the available heights and widths in this slot.
      // There will always be the same number heights and widths fields.
      repeated int32 height = 1 [packed=true];
      repeated int32 width  = 2 [packed=true];

      // These are the formats of the creatives allowed in this companion ad slot.
      enum CreativeFormat {
        IMAGE_CREATIVE = 0;
        FLASH_CREATIVE = 1;
        HTML_CREATIVE  = 2;
      }
      repeated CreativeFormat creative_format = 3;
    }
    repeated CompanionSlot companion_slot = 7;
  }
  optional Video video = 29;

  // The publisher settings list id that applies to this page.  See the
  // Targeting section of the RTB documentation for details.
  optional fixed64 publisher_settings_list_id = 42;

  // -----------------------------------------------------------
  // Information about the adslots on the page.
  //
  message AdSlot {

    // An arbitrarily assigned slot id that is unique on a given page and
    // usually starts counting from 1.  You use this to identify which slot to
    // bid on in the BidResponse.
    required int32 id = 1;

    // Unique identifier for this adslot's ad block for the page URL.
    optional uint64 ad_block_key = 14;

    // Set of channels of which this ad slot is a member.  A channel is a set of
    // ad slots on a site.  You can target a channel (like "the sports section",
    // or "all top banners") to get more fine-grained control over where your ad
    // shows.  Channel names are provided by the publisher.
    repeated string targetable_channel = 10;

    // The width and height in pixels of the allowed ad sizes.  Most requests
    // allow only a single size, but some allow more than one.  Widths and
    // heights must be at the same index.  For example, if the width values are
    // [728, 300, 468] and the height values are [90, 250, 60], then the allowed
    // formats are 728x90, 300x250, and 468x60.
    repeated int32 width = 2;
    repeated int32 height = 3;

    // The disallowed attribute ids for the ads that can show in this slot.  See
    // the publisher-excluded-creative-attributes.txt file in the technical
    // documentation for a list of ids.
    repeated int32 excluded_attribute = 4 [packed=true];

    // The allowed vendor types.  See the vendors.txt file in the technical
    // documentation for a list of ids.  When the seller_network is GDN, the
    // vendor ids listed in gdn-vendors.txt in the supporting technical
    // documentation are also allowed.
    repeated int32 allowed_vendor_type = 6 [packed=true];

    // The disallowed sensitive ad categories.  See the
    // ad-sensitive-categories.txt file in the technical documentation for a
    // list of ids.  You should enforce these exclusions if you have the ability
    // to classify ads into the listed categories.
    repeated int32 excluded_sensitive_category = 7 [packed=true];

    // The disallowed ad product categories.  See the ad-product-categories.txt
    // file in the technical documentation for a list of ids.  You should
    // enforce these exclusions if you have the ability to classify ads into the
    // listed categories.
    repeated int32 excluded_product_category = 13 [packed=true];

    // Information about the pre-targeting campaigns and adgroups that matched.
    //
    message MatchingAdData {
      // The adgroup id of the matching ad.
      optional int64 adgroup_id = 2;

      // The minimum CPM value that you can bid to not be filtered before the
      // auction.  This may be a global minimum, or it may be a minimum set by
      // the publisher.  The value is in micros of your account currency.
      optional int64 minimum_cpm_micros = 5;

      // Information about any direct deals that matched for this inventory.
      //
      message DirectDeal {
        // An id identifying the deal.
        optional int64 direct_deal_id = 1;

        // The fixed CPM deal that applies to your account for this adslot.  If
        // you choose to bid on this impression, then you must bid at least the
        // value of fixed_cpm_micros, and if you win, you will always be charged
        // fixed_cpm_micros.  The value is in micros of your account currency.
        // For example, if the fixed cpm is 1290000 (1.29 in your account
        // currency), then you need to bid at least this amount.  If you win,
        // you will be charged a CPM of 1.29 in your account currency.
        optional int64 fixed_cpm_micros = 2;
      }
      repeated DirectDeal direct_deal = 6;

      // These are deprecated.  Please ignore.
      optional int64 DEPRECATED_campaign_id = 1;
      optional bool DEPRECATED_per_buyer_minimum_cpm = 3;
      optional int64 DEPRECATED_fixed_cpm_micros = 4;
    }
    repeated MatchingAdData matching_ad_data = 9;

    // The publisher settings list ids that apply to this slot.  See the
    // Targeting section of the RTB documentation for details.
    optional fixed64 publisher_settings_list_id = 15;

    // Visibility information for the slot.
    enum SlotVisibility  {
      NO_DETECTION = 0;
      ABOVE_THE_FOLD = 1;
      BELOW_THE_FOLD = 2;
    }
    optional SlotVisibility slot_visibility = 12 [default = NO_DETECTION];

    // These are deprecated.  Please ignore.
    repeated int32 DEPRECATED_allowed_attribute = 5;
    repeated bytes DEPRECATED_publisher_settings_list_id = 11;
    repeated string DEPRECATED_excluded_click_through_url = 8;
  }
  repeated AdSlot adslot = 14;

  // Feedback on bids submitted in previous responses.  This is only set if
  // real-time feedback is enabled for your bidder.  Please contact your account
  // manager if you wish to enable real-time feedback.
  //
  message BidResponseFeedback {
    // The unique id from BidRequest.id
    optional bytes request_id = 1;

    // The index of the creative within the BidResponse if there was more than
    // one.  The index starts at zero for the first creative.  This is usually
    // the index of the BidResponse.Ad, but may be the
    // BidResponse.Ad.TemplateParameter if you use a template ad.
    optional int32 creative_index = 2;

    // The status code for the ad.  See creative-status-codes.txt in the
    // technical documentation for a list of ids.
    optional int32 creative_status_code = 3;

    // The second price cpm in micros of your account currency if your bid won
    // the auction, or the winning bid that must be exceeded to win the auction
    // if your ad did not win.  This is only set if your bid participated in the
    // auction.  It is not set if the bid was filtered prior to the auction.  It
    // is also witheld if the publisher or winning bidder has opted out of price
    // feedback, or if your account has opted out of sharing winning prices
    // with other bidders.
    optional int64 cpm_micros = 4;
  }
  repeated BidResponseFeedback bid_response_feedback = 44;

  // -----------------------------------------------------------
  // Testing flags.

  // If true, then this is a test request.  Results will not be displayed to
  // users and you will not be billed for a response even if it wins the
  // auction.  You should still do regular processing since the request may be
  // used to evaluate latencies or for other testing.
  optional bool is_test = 15 [default=false];

  // If true, then this request is intended to measure network latency.  Please
  // return an empty BidResponse with only processing_time_ms set as quickly as
  // possible without executing any bidding logic.
  optional bool is_ping = 17 [default=false];

  // If true, then this request is using an experimental deadline greater than
  // the normal 100ms.  We will sometimes send a small number of requests with
  // experimental_deadline=true to evaluate the effect of different deadlines on
  // spend.  Requests with experimental_deadline=true are for real impressions
  // and you should bid on them normally.  However, if you use internal timeouts
  // to abort processing when it is taking too long as a way of keeping your
  // error rate low, then you can disable these internal timeouts for requests
  // with experimental_deadline=true.  The effect on your error rate will be
  // limited since we will only set this on a small percentage of requests.
  // Paying attention to experimental_deadline is optional, but you may choose
  // to do so if you would benefit from higher deadlines and therefore wish to
  // help us accurately measure the effect of raising them.
  optional bool experimental_deadline = 35 [default=false];

  // These are deprecated.  Please ignore.
  optional int32 DEPRECATED_protocol_version = 1;
  optional string DEPRECATED_click_tracking_url = 3;
  optional uint64 DEPRECATED_cookie = 5;
  optional string DEPRECATED_country = 7;
  optional string DEPRECATED_region = 8;
  optional string DEPRECATED_city = 9;
  optional int32 DEPRECATED_metro = 10;
  optional bytes DEPRECATED_hashed_cookie = 16;
  repeated string DEPRECATED_excluded_click_through_url = 18;
  optional string DEPRECATED_seller_network = 22;
  optional bytes DEPRECATED_publisher_settings_list_id = 23;
  message MatchingNetwork {
    optional string DEPRECATED_network_id = 1;
    optional string DEPRECATED_google_user_id = 2;
  }
  repeated MatchingNetwork DEPRECATED_matching_network = 27;
}
